<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Riverwood AI Voice Agent</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  margin: 0;
  padding: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}
.container {
  width: 90%;
  max-width: 800px;
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.header {
  background: #2c3e50;
  color: white;
  padding: 20px;
  text-align: center;
}
.header h1 { margin: 0; font-size: 1.8rem; }
.header p { margin: 6px 0 0; font-size: 1rem; opacity: 0.8; }
.chat-container {
  height: 400px;
  overflow-y: auto;
  background: #f8f9fa;
  padding: 15px;
}
.message {
  max-width: 80%;
  margin-bottom: 12px;
  padding: 10px 15px;
  border-radius: 16px;
  line-height: 1.4;
  font-size: 15px;
  animation: fadeIn 0.3s ease-in;
}
.user-message {
  background: #007bff;
  color: white;
  margin-left: auto;
  border-bottom-right-radius: 5px;
}
.ai-message {
  background: white;
  border: 1px solid #ddd;
  color: #333;
  border-bottom-left-radius: 5px;
}
.message-time {
  font-size: 0.8em;
  opacity: 0.6;
  margin-top: 3px;
}
.input-bar {
  display: flex;
  gap: 10px;
  align-items: center;
  padding: 15px;
  border-top: 1px solid #ddd;
  background: white;
}
#user-input {
  flex: 1;
  padding: 10px 15px;
  border-radius: 25px;
  border: 2px solid #ddd;
  outline: none;
  font-size: 15px;
}
.btn {
  border: none;
  border-radius: 25px;
  padding: 10px 18px;
  cursor: pointer;
  font-size: 15px;
}
.btn-send {
  background: #007bff;
  color: white;
}
.btn-voice {
  background: #28a745;
  color: white;
}
.btn-voice.listening {
  background: #dc3545;
  animation: pulse 1s infinite;
}
@keyframes pulse {
  0%,100%{transform:scale(1);}50%{transform:scale(1.05);}
}
@keyframes fadeIn {
  from {opacity:0;transform:translateY(10px);}
  to {opacity:1;transform:translateY(0);}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üèóÔ∏è Riverwood AI Voice Agent</h1>
    <p>Building Relationships, Not Just Real Estate</p>
  </div>

  <div class="chat-container" id="chat"></div>

  <div class="input-bar">
    <input id="user-input" placeholder="Type or speak..." />
    <button class="btn btn-send" onclick="sendMessage()">Send</button>
    <button id="voice-btn" class="btn btn-voice" onclick="toggleVoice()">üé§ Speak</button>
  </div>
</div>

<script>
let recognition = null;
let isListening = false;
let history = [];

// --- transliteration map (fixes "aapka" issue)
function transliterateHinglishToHindi(text) {
  const map = {
    "namaste": "‡§®‡§Æ‡§∏‡•ç‡§§‡•á",
    "aapka": "‡§Ü‡§™‡§ï‡§æ",
    "kaisa": "‡§ï‡•à‡§∏‡§æ",
    "ho": "‡§π‡•ã",
    "chai": "‡§ö‡§æ‡§Ø",
    "pee": "‡§™‡•Ä",
    "li": "‡§≤‡•Ä",
    "achha": "‡§Ö‡§ö‡•ç‡§õ‡§æ",
    "haan": "‡§π‡§æ‡§Å",
    "nahi": "‡§®‡§π‡•Ä‡§Ç",
    "thank": "‡§•‡•à‡§Ç‡§ï",
    "you": "‡§Ø‡•Ç",
    "riverwood": "‡§∞‡§ø‡§µ‡§∞‡§µ‡•Å‡§°"
  };

  let words = text.split(" ");
  return words.map(w => map[w.toLowerCase()] || w).join(" ");
}

// --- initialize speech recognition
function initSpeechRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return alert("Speech Recognition not supported!");
  recognition = new SpeechRecognition();
  recognition.lang = "en-IN";
  recognition.interimResults = false;

  recognition.onstart = () => {
    isListening = true;
    document.getElementById('voice-btn').classList.add('listening');
  };
  recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    document.getElementById('user-input').value = transcript;
    stopListening();
    sendMessage();
  };
  recognition.onerror = () => stopListening();
  recognition.onend = () => stopListening();
}

function startListening() {
  if (recognition) recognition.start();
}
function stopListening() {
  if (recognition) recognition.stop();
  isListening = false;
  document.getElementById('voice-btn').classList.remove('listening');
}
function toggleVoice() {
  isListening ? stopListening() : startListening();
}

// --- speak text with natural Hindi/Indian voice
function speakText(text) {
  if (!('speechSynthesis' in window)) return;

  const synth = window.speechSynthesis;
  let voices = synth.getVoices();

  if (!voices.length) {
    synth.onvoiceschanged = () => {
      voices = synth.getVoices();
      speakText(text);
    };
    return;
  }

  // transliterate Hinglish to Hindi for better pronunciation
  const hindiText = transliterateHinglishToHindi(text);

  const utter = new SpeechSynthesisUtterance(hindiText);
  utter.lang = "hi-IN";  // Hindi voice
  utter.rate = 0.85;     // slower, smoother
  utter.pitch = 1.0;     // natural tone

  const voice = voices.find(v =>
    v.lang.toLowerCase().includes("hi-in") ||
    v.name.toLowerCase().includes("hindi")
  ) || voices.find(v => v.lang.toLowerCase().includes("en-in")) || voices[0];

  utter.voice = voice;

  // slight pause before speaking
  setTimeout(() => {
    synth.cancel();
    synth.speak(utter);
  }, 600);
}

// --- add messages to chat
function addMessage(text, sender) {
  const chat = document.getElementById('chat');
  const div = document.createElement('div');
  div.className = `message ${sender}-message`;
  div.innerHTML = `${text}<div class='message-time'>${new Date().toLocaleTimeString()}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// --- send message to Flask backend
async function sendMessage() {
  const input = document.getElementById('user-input');
  const msg = input.value.trim();
  if (!msg) return;

  addMessage(msg, 'user');
  history.push({ role: 'user', content: msg });
  input.value = '';

  const res = await fetch('/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ message: msg, history })
  });

  const data = await res.json();
  const reply = data.response;
  addMessage(reply, 'ai');
  history.push({ role: 'assistant', content: reply });
  speakText(reply);
}

// --- initial greeting on first click
window.onload = () => {
  initSpeechRecognition();
  document.body.addEventListener('click', function startChat() {
    const greeting = "Namaste ji! Main Riverwood AI Assistant hoon. Aapka din kaisa jaa raha hai? Chai pee li?";
    addMessage(greeting, 'ai');
    history.push({ role: 'assistant', content: greeting });
    speakText(greeting);
    document.body.removeEventListener('click', startChat);
  });
};
</script>
</body>
</html>
